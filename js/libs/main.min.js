var express=require("express"),bodyParser=require("body-parser"),Web3=require("web3"),contract=require("truffle-contract"),$=require("jquery"),conf=require("./config"),provider=require("./web3provider"),path=require("path"),cjson=require("cjson"),conf=cjson.load(["./config.json","./config.local.json"],!0),abi=cjson.load(conf.web3.btmballot_contract.abi),web3=new Web3(new Web3.providers.HttpProvider(conf.web3.provider)),VotingContract=contract(abi);VotingContract.setProvider(new Web3.providers.HttpProvider(conf.web3.provider));var app=express();app.use(bodyParser.urlencoded({extended:!1})),app.use(require("express-jquery")("/jquery.js")),app.post("/user/register",function(e,o){var t=e.body.firstName,n=e.body.lastName,r=e.body.myEmail,a=e.body.identity,s=e.body.myAddress,c=e.body.telephone,i=e.body.voterAddress;VotingContract.deployed().then(function(e){return e.registerVoters(t,n,r,a,s,c,{from:i,gas:2e6})}).then(function(e){console.log("Successfully Registered as"+t+n)})["catch"](function(e){console.log("ERROR! "+e.message),console.log("You cannot Register Twice or Edit your details")}),o.send("Successfully Registered as a Voter ")}),app.post("admin/register/party",function(e,o){var t=e.body.partyName,n=e.body.partyID;VotingContract.deployed().then(function(e){var o=e.chairperson();return console.log(o),e.registerParty(n,t,{from:o,gas:2e6})}).then(function(e){console.log("Party Registered")})["catch"](function(e){consol.log("ERROR! "+e.message)}),o.send("successfully registered the party")}),app.post("/admin/election",function(e,o){var t=e.body.electionAgenda,n=e.body.electionDate;VotingContract.deployed().then(function(e){return e.registerParty(t,n,{from:web3.eth.coinbase,gas:2e6})}).then(function(e){console.log("Election Created")})["catch"](function(e){console.log("ERROR! "+e.message)}),o.send("Success")}),app.post("/admin/election/start",function(e,o){var t=e.body.inputelectionID;VotingContract.deployed().then(function(e){return e.startElection(t,{from:web3.eth.coinbase,gas:2e6})}).then(function(e){console.log("Election"+t+"started")})["catch"](function(e){console.log("ERROR! "+e.message)}),o.send("Started")}),app.post("/user/election/vote",function(e,o){var t=e.body.selectedParty,n=e.body.voterAddress;VotingContract.deployed().then(function(e){return e.vote(t,{from:n,gas:2e6})}).then(function(e){console.log("Vote for "+t+"cast")}),o.send("Vote cast")}),app.post("/admin/election/stop",function(e,o){var t=e.body.inputelectionID;VotingContract.deployed().then(function(e){return e.stopElection(t,{from:web3.eth.coinbase,gas:2e6})}).then(function(e){console.log("Election"+t+"stopped")})["catch"](function(e){console.log("ERROR! "+e.message)}),o.send("Stopped")}),app.post("/admin/election/auth/voter",function(e,o){var t=e.body.voterAddress;VotingContract.deployed().then(function(e){return e.giveRightToVote(t,{from:web3.eth.coinbase,gas:2e6})}).then(function(e){console.log("Voter"+t+"Given Vote Privileges")})["catch"](function(e){console.log("ERROR! "+e.message)}),o.send("Authenticated")}),app.post("/admin/election/switchAdmin",function(e,o){var t=e.body.adminAddress;VotingContract.deployed().then(function(e){return e.switchRegistar(t,{from:web3.eth.coinbase,gas:2e6})}).then(function(e){console.log("The new Admin is"+t)})["catch"](function(e){console.log("ERROR! "+e.message)}),o.send("Switched")}),app.post("/user/delegatevote",function(e,o){var t=(e.body.inputDelegate,e.body.inputDelegateAddress);VotingContract.deployed().then(function(e){return e.delegate(t)}).then(function(e){console.log("You Delagate your vote to"+t),console.log("Your Reason is"+t)})["catch"](function(e){console.log("ERROR! "+e.message)}),o.send("Successfully Delegated")}),app.post("/user/unlockAccount",function(e,o){var t,n=e.body.address,r=e.body.passphrase;VotingContract.deployed().then(function(e){t=e,web3.personal.unlockAccount(n,r)}).then(function(e){Console.log("Unlocked")})["catch"](function(e){console.log("ERROR! "+e.message)}),o.send("Successfully Unlocked")}),app.get("/election/results",function(e,o){var t,n=e.param("partyName"),r=e.param("votesCast"),a=e.param("partyRank");VotingContract.deployed().then(function(e){t=e;var o=e.numParties();for(counter=1;counter<o;counter++)return a=e.talliedPartyRank(a),n=e.talliedPartyName(a),r=e.talliedPartyVotes(a),e.talliedPartyRank(a),e.talliedPartyName(a),e.talliedPartyVotes(a)}).then(function(e){console.log(s.arg)})["catch"](function(e){console.log("ERROR! "+e.message)});var s={partyRank:a,partyName:n,votesCast:r};o.send(s)}),app.get("/election/winningparty",function(e,o){var t=e.param("partyName"),n=e.param("totalVotes");VotingContract.deployed().then(function(e){return t=e.winnerName(),n=e.winnerVotes(),e.winnerName(),e.winnerVotes()}).then(function(e){console.log("The winnerName is"+t)})["catch"](function(e){console.log("ERROR! "+e.message)});o.send(t+""+n)}),app.listen(8e3,function(e){e||console.log("Server is Running on port 8000")});